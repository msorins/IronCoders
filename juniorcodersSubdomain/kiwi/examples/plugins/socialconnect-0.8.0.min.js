Kiwi.Plugins.SocialConnect={name:"SocialConnect",version:"0.8.0",minimumKiwiVersion:"1.0.0"},Kiwi.PluginManager.register(Kiwi.Plugins.SocialConnect),Kiwi.Plugins.SocialConnect.create=function(a){a.social=new Kiwi.Plugins.SocialConnect.Manager(a)},Kiwi.Plugins.SocialConnect.Manager=function(a){this.game=a,this.gamefroot=new Kiwi.Plugins.SocialConnect.Gamefroot(this.game),this.facebook=new Kiwi.Plugins.SocialConnect.Facebook(this.game)},Kiwi.Plugins.SocialConnect.Manager.prototype.init=function(a){a=a||{},a.gamefroot&&console.warn("SocialConnect: Gamefroot does not need initialising."),a.facebook&&this.facebook.init(a.facebook),a.twitter&&console.error("SocialConnect: Twitter has not been implemented just yet."),a.google&&console.error("SocialConnect: Google Plus has not been implemented just yet.")},Kiwi.Plugins.SocialConnect.Base=function(a,b,c){this.game=a,this.name=b,this._initialized=!1,c=c||{},this.settings={init:!0,login:!1,share:!1},this._readConfig(c)},Kiwi.Plugins.SocialConnect.Base.prototype._readConfig=function(a){"undefined"!=typeof a.init&&(this.settings.init=a.init),"undefined"!=typeof a.login&&(this.settings.login=a.login),"undefined"!=typeof a.share&&(this.settings.share=a.share)},Object.defineProperty(Kiwi.Plugins.SocialConnect.Base.prototype,"initialized",{get:function(){return this._initialized},enumerable:!0,configurable:!0}),Kiwi.Plugins.SocialConnect.Base.prototype.init=function(a){if(!this.settings.init)return this.log("doesn't require initialization"),!1;if(a=a||{},this._initialized)return this.log("has already been initialized. Skipping re-initalization.",2),!1;if("undefined"!=typeof this._init){var b=this._init.call(this,a);return b&&(this._initialized=!0),b}},Kiwi.Plugins.SocialConnect.Base.prototype.login=function(a){return a=a||{},this.settings.login?this.settings.init&&!this._initialized?(this.log("has not been initialized.",2),!1):"undefined"!=typeof this._login?this._login.call(this,a):void 0:(this.log("doesn't has login functionality."),!1)},Kiwi.Plugins.SocialConnect.Base.prototype.share=function(a){return a=a||{},this.settings.share?this.settings.init&&!this._initialized?(this.log("has not been initialized.",2),!1):"undefined"!=typeof this._share?this._share.call(this,a):void 0:(this.log("doesn't has sharing functionality."),!1)},Kiwi.Plugins.SocialConnect.Base.prototype.log=function(a,b){if(this.game.debug)switch(a="SocialConnect:"+this.name+" "+a,b){default:case 1:console.log(a);break;case 2:console.warn(a);break;case 3:console.error(a)}},Kiwi.Plugins.SocialConnect.Facebook=function(a){if(Kiwi.Plugins.SocialConnect.Base.call(this,a,"Facebook",{login:!0,share:!0}),this.userID=null,this.userInfo={},this._ready=!1,this.sdkUrl="http://connect.facebook.net/en_US/sdk.js",this._cocoon=!1,this.game.deviceTargetOption==Kiwi.TARGET_COCOON){if(this._cocoon=!0,!Cocoon||!Cocoon.Social.Facebook)return this.log("CocoonJS intergration requires you to include the Cocoon JavaScript library.",3),void(this._ready=!1);this.fb=Cocoon.Social.Facebook,this._ready=!0}else this._SDKLoaded()},Kiwi.extend(Kiwi.Plugins.SocialConnect.Facebook,Kiwi.Plugins.SocialConnect.Base),Kiwi.Plugins.SocialConnect.Facebook.prototype._SDKLoaded=function(){var a="undefined"!=typeof window.FB;a&&(this.fb=window.FB,this._ready=!0)},Kiwi.Plugins.SocialConnect.Facebook.prototype._include=function(a){"undefined"==typeof region&&(region="en_US");var b,c=document.getElementsByTagName("script")[0];b=document.createElement("script"),"undefined"!=typeof a&&(b.onload=a),b.id="facebook-jssdk",b.src=this.sdkUrl,c.parentNode.insertBefore(b,c)},Object.defineProperty(Kiwi.Plugins.SocialConnect.Facebook.prototype,"ready",{get:function(){return this._ready},enumerable:!0,configurable:!0}),Kiwi.Plugins.SocialConnect.Facebook.prototype._init=function(a){if(!a.appId)return this.log("AppId is undefined.",3),!1;if(a.version=a.version||"v2.2","undefined"==typeof a.status&&(a.status=!0),this.game.deviceTargetOption!=Kiwi.TARGET_COCOON||a.channelUrl||(a.channelUrl=this.sdkUrl),this.game.deviceTargetOption===Kiwi.TARGET_COCOON||this._SDKLoaded())return this.fb.init(a),!0;this.log("SDK not detected. Loading one in, and initializing after.",2);var b=this;return window.fbAsyncInit=function(){FB.init(a),b._SDKLoaded()},this._include(),!0},Kiwi.Plugins.SocialConnect.Facebook.prototype._login=function(a){var b=this;return a.loginWithGF?(this.game.social.gamefroot.loginWithFB(a),!0):(this.fb.login(function(c){var d=!1,e=!1;"connected"==c.status?(e=!0,d=!0,b.userID=c.authResponse.userID):"not_authorized"==c.status&&(e=!0,d=!1),"undefined"!=typeof a.callback&&a.callback.call(a.context,d,c,e)},a.options),!0)},Object.defineProperty(Kiwi.Plugins.SocialConnect.Facebook.prototype,"loggedIn",{get:function(){return null!==this.userID},enumerable:!0,configurable:!0}),Kiwi.Plugins.SocialConnect.Facebook.prototype.loginApproved=function(a){if(!a||!a.callback)return this.log("a callback needs to be passed in-order to function correctly.",2),!1;var b=this;return this.fb.getLoginStatus(function(c){var d=!1,e=!1;switch(c.status){case"connected":d=!0,e=!0,b.userID=c.authResponse.userID;break;case"not_authorized":d=!0;default:e=!1}a.callback.call(a.context,e,d,c)}),!0},Kiwi.Plugins.SocialConnect.Facebook.prototype.hasPermissions=function(a){return a&&a.permissions?a.callback?this.loggedIn?(this.fb.api(this.userID+"/permissions",function(b){for(var c,d,e,f,g=0,h=[],c=0,i=b.data.length;i>c;c++)if(d=b.data[c],"granted"==d.status)for(h.push(e),f=a.permissions.length;f--;)e=a.permissions[f],d.permission==e&&g++;g>=a.permissions.length?a.callback.call(a.context,!0,h,b):a.callback.call(a.context,!1,h,b)}),!0):(this.log("we could not detected if the user is currently logged in.",2),a.callback.call(a.context,!1,[]),!1):(this.log("a callback needs to be passed in-order to function correctly.",2),!1):(this.log("you need to pass an array of permissions.",2),!1)},Kiwi.Plugins.SocialConnect.Facebook.prototype.logout=function(a){a=a||{};var b=this;this.fb.logout(function(c){b.userID=null,b.userInfo=null,"undefined"!=typeof a.callback&&a.callback.call(a.context,c)}.bind(this))},Kiwi.Plugins.SocialConnect.Facebook.prototype.me=function(a){if(!this._init||!this._ready)return this.log("has not been initialized, or isn't ready.",2),!1;if(!this.loginApproved)return this.log("user is not logged in",3),!1;a=a||{},a.pictureKey||(a.pictureKey="fb-current-user"),a.fields=a.fields?"?fields="+a.fields:"";var b=this;return this.fb.api("/me"+a.fields,function(c){(a.saveData||"undefined"==typeof a.saveData)&&(b.userInfo=c),a.autoLoadPicture&&c.picture&&c.picture.data&&c.picture.data.url?b._loadImage(a.pictureKey,c.picture.data.url,a.callback,a.context,c):"undefined"!=typeof a.callback&&a.callback.call(a.context,c)}),!0},Kiwi.Plugins.SocialConnect.Facebook.prototype._loadImage=function(a,b,c,d,e){e=e||null;var f=this;this.game.loader.init(null,function(){var b=f.game.fileStore.getFile(a);b.isTexture&&f.game.states.current.textureLibrary.addFromFile(b),"undefined"!=typeof c&&c.call(d,e)}),this.game.loader.addImage(a,b),this.game.loader.startLoad()},Kiwi.Plugins.SocialConnect.Facebook.prototype.myImage=function(a){if(!this._init||!this._ready)return this.log("has not been initialized, or isn't ready.",2),!1;if(!this.loginApproved)return this.log("user is not logged in",3),!1;if(a=a||{},a.pictureKey||(a.pictureKey="fb-current-user"),!this.loggedIn)return this.log("we could not detected if the user is currently logged in.",2),a.callback.call(a.context,!1,[],resp),!1;var b=this,c=this.userID+"/picture?";a.width&&(c+="width="+a.width+"&"),a.height&&(c+="height="+a.height+"&"),this.fb.api(c,function(c){c.data&&c.data.url?b._loadImage(a.pictureKey,c.data.url,a.callback,a.context,c):a.callback.call(a.context,c)})},Kiwi.Plugins.SocialConnect.Facebook.prototype._share=function(a){a=a||{},a.method="share","undefined"!=typeof a.link||this._cocoon||(a.link=window.location.href),this._cocoon?this.fb.showShareDialog(a,function(b){"undefined"!=typeof a.callback&&"undefined"!=typeof a.context&&a.callback.call(a.context,b)}):("undefined"!=typeof a.link&&(a.href=a.link,delete a.link),this.fb.ui(a,function(b){"undefined"!=typeof a.callback&&"undefined"!=typeof a.context&&a.callback.call(a.context,b)}))},Kiwi.Plugins.SocialConnect.Gamefroot=function(a){Kiwi.Plugins.SocialConnect.Base.call(this,a,"Gamefroot",{login:!0,share:!1,init:!1}),this._ready=!0,this.userInfo=null,this.timeout=3e4,this.serverURL=Kiwi.Plugins.SocialConnect.Gamefroot.ServerURL.LIVE},Kiwi.extend(Kiwi.Plugins.SocialConnect.Gamefroot,Kiwi.Plugins.SocialConnect.Base),Kiwi.Plugins.SocialConnect.Gamefroot.ServerURL={LIVE:"http://198.206.133.200:8081/api/",DEBUG:"http://staging.gamefroot.com:8081/api/"},Object.defineProperty(Kiwi.Plugins.SocialConnect.Gamefroot.prototype,"ready",{get:function(){return this._ready},enumerable:!0,configurable:!0}),Object.defineProperty(Kiwi.Plugins.SocialConnect.Gamefroot.prototype,"loggedIn",{get:function(){return null!==this.userInfo},enumerable:!0,configurable:!0}),Kiwi.Plugins.SocialConnect.Gamefroot.prototype.register=function(a){if(a=a||{},!a.callback)return this.log("a callback needs to be passed in-order to function correctly.",2),!1;if(!(a.username&&a.password&&a.email&&a.passwordrepeat))return this.log("not all of the needed parameters have been passed.",2),!1;var b={usrn:a.username,psw:a.password,email:a.email,repsw:a.passwordrepeat};return this._apiRequest("account/register",b,function(b,c){2==b?a.callback.call(a.context,!1,c):"success"==c.result?a.callback.call(a.context,!0,c):a.callback.call(a.context,!1,c)},!0)},Kiwi.Plugins.SocialConnect.Gamefroot.prototype._login=function(a){if(!a.callback)return this.log("a callback needs to be passed in-order to function correctly.",2),!1;if(!a.username||!a.password)return this.log("not all of the needed parameters have been passed.",2),!1;var b={usrn:a.username,psw:a.password,ref:this.game.stage.name},c=this;return this._apiRequest("account/login",b,function(b,d){2==b?a.callback.call(a.context,!1,d):d.result?"fail"==d.result?a.callback.call(a.context,!1,d):(c.userInfo=d,a.callback.call(a.context,!0,d)):a.callback.call(a.context,!1,d)},!0)},Kiwi.Plugins.SocialConnect.Gamefroot.prototype.loginWithFB=function(a){return a=a||{},a.callback?this.game.social.facebook.loginApproved({context:this,callback:function(b){b?this._fbRetrieveUserData(a):this.game.social.facebook.login({context:this,options:a.options,callback:function(b){return b?void this._fbRetrieveUserData(a):void a.callback.call(a.context,!1,"not logged into facebook.")}})}}):(this.log("a callback needs to be passed in-order to function correctly.",2),!1)},Kiwi.Plugins.SocialConnect.Gamefroot.prototype._fbRetrieveUserData=function(a){var b=this.game.social.facebook.me({context:this,callback:function(b){this._fbLoginToGF(b,a)}});b||a.callback.call(a.context,!1,"error with getting information from facebook.")},Kiwi.Plugins.SocialConnect.Gamefroot.prototype._fbLoginToGF=function(a,b){var c={type:"fb",id:a.id,fullRes:JSON.stringify(a),ref:this.game.stage.name},d=this;return this._apiRequest("account/login",c,function(a,c){2===a?b.callback.call(b.context,!1,c):c.result?"fail"===c.result?b.callback.call(b.context,!1,c):(d.userInfo=c,b.callback.call(b.context,!0,c)):b.callback.call(b.context,!1,c)},!0)},Kiwi.Plugins.SocialConnect.Gamefroot.prototype.logout=function(a){return a=a||{},this._apiRequest("account/logout",{},function(b,c){that.userInfo=null,2===b&&a.callback&&a.callback.call(a.context,!1,c),a.callback&&a.callback.call(a.context,!0,c)},!0)},Kiwi.Plugins.SocialConnect.Gamefroot.prototype._apiRequest=function(a,b,c,d){if(!this._ready)return this.log("not ready to make another request yet.",2),!1;var e,f,g,h=this;e=d?"POST":"GET",f=null;for(var i in b)null===f?f=i+"="+encodeURIComponent(b[i]):f+="&"+i+"="+encodeURIComponent(b[i]);return g=new XMLHttpRequest,g.open(e,this.serverURL+a,!0),d&&g.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),g.timeout=this.timeout,g.ontimeout=function(){h._error("request has timed out.",c)},g.onabort=function(){h._error("request was aborted.",c)},g.onerror=function(){h._error("request encountered an error.",c)},g.onreadystatechange=function(a){if(4===a.target.readyState){if(g.response)var b=JSON.parse(g.response);else var b={};h._ready=!0,c.call(this,1,b)}},g.send(f),this._ready=!1,!0},Kiwi.Plugins.SocialConnect.Gamefroot.prototype._error=function(a,b){this._ready=!0,this.log(a,2),b.call(this,2,a)},Kiwi.Plugins.SocialConnect.Twitter=function(a){Kiwi.Plugins.SocialConnect.Base.call(this,a,"Twitter",{login:!1,share:!1,init:!1}),this._ready=!1},Kiwi.extend(Kiwi.Plugins.SocialConnect.Twitter,Kiwi.Plugins.SocialConnect.Base),Kiwi.Plugins.SocialConnect.Twitter.prototype._include=function(){},Object.defineProperty(Kiwi.Plugins.SocialConnect.Twitter.prototype,"ready",{get:function(){return this._ready},enumerable:!0,configurable:!0}),Kiwi.Plugins.SocialConnect.Twitter.prototype._init=function(){},Kiwi.Plugins.SocialConnect.Twitter.prototype._login=function(){},Kiwi.Plugins.SocialConnect.Twitter.prototype.logout=function(){},Kiwi.Plugins.SocialConnect.Twitter.prototype._share=function(){};