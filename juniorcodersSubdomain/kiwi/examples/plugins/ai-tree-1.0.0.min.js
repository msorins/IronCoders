Kiwi.Plugins.AiTree={name:"AiTree",version:"1.0.0"},Kiwi.PluginManager.register(Kiwi.Plugins.AiTree),Kiwi.Plugins.AiTree.getTime=function(){return window.performance.now?window.performance.now():window.performance.webkitNow?window.performance.webkitNow():(new Date).getTime()},Kiwi.Plugins.AiTree.Ai=function(a){return Kiwi.Component.call(this,a,"AiTree"),this._root=void 0,this.uniqueChildren=[],this},Kiwi.extend(Kiwi.Plugins.AiTree.Ai,Kiwi.Component),Object.defineProperty(Kiwi.Plugins.AiTree.Ai.prototype,"root",{get:function(){return this._root},set:function(a){this.setRoot(a)}}),Kiwi.Plugins.AiTree.Ai.prototype.addChild=function(a){return this.setRoot(a)},Kiwi.Plugins.AiTree.Ai.prototype.hasAncestor=function(){return!1},Kiwi.Plugins.AiTree.Ai.prototype.hasDescendant=function(a){var b;for(b=0;b<this.uniqueChildren.length;b++)if(a===this.uniqueChildren[b])return!0;return!1},Kiwi.Plugins.AiTree.Ai.prototype.setRoot=function(a){return void 0!==a&&(this._root=a,this.root.addParent(this),this.updateCensus()),a},Kiwi.Plugins.AiTree.Ai.prototype.update=function(){var a,b=Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_ERROR;for(a=0;a<this.uniqueChildren.length;a++)this.uniqueChildren[a].reset();return this.root&&void 0!==this.root.update&&(b=this.root.update()),b},Kiwi.Plugins.AiTree.Ai.prototype.updateCensus=function(){var a,b=this.root.getDescendants();for(this.uniqueChildren=[this.root],a=0;a<b.length;a++)-1===this.uniqueChildren.indexOf(b[a])&&this.uniqueChildren.push(b[a]);return!0},Kiwi.Plugins.AiTree.OuterNode=function(a){return null==a&&(this.params={}),this.name=a.name||this.DEFAULT_NODE_NAME,this.status=this.STATUS_READY,this.runningDirty=!1,this.runsParent=a.runsParent||!0,this.parents=[],this},Kiwi.Plugins.AiTree.OuterNode.prototype.DEFAULT_NODE_NAME="Untitled outer node",Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_READY=0,Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_RUNNING=1,Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_SUCCESS=2,Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_FAILURE=3,Kiwi.Plugins.AiTree.OuterNode.prototype.STATUS_ERROR=4,Kiwi.Plugins.AiTree.OuterNode.prototype.addParent=function(a){return-1===this.parents.indexOf(a)?(this.parents.push(a),!0):!1},Kiwi.Plugins.AiTree.OuterNode.prototype._onUpdate=function(){},Kiwi.Plugins.AiTree.OuterNode.prototype.removeParent=function(a){var b=this.parents.indexOf(a);return-1!==b?(this.parents.splice(b,1),!0):!1},Kiwi.Plugins.AiTree.OuterNode.prototype.reset=function(){return this.status===this.STATUS_RUNNING&&this.runningDirty?void(this.runningDirty=!1):(this.status===this.STATUS_ERROR&&console.log("Error detected in "+this.name,this),void(this.status=this.STATUS_READY))},Kiwi.Plugins.AiTree.OuterNode.prototype._run=function(){},Kiwi.Plugins.AiTree.OuterNode.prototype.update=function(){return this._onUpdate(),this._run(),this.runningDirty=this.status===this.STATUS_RUNNING?!0:!1,this.status},Kiwi.Plugins.AiTree.OuterNode.prototype.updateCensus=function(){var a,b;for(a=0;a<this.parents.length;a++)if(b=this.parents[a].updateCensus())return!0;return!1},Kiwi.Plugins.AiTree.InnerNode=function(a){return Kiwi.Plugins.AiTree.OuterNode.call(this,a),this.children=[],this.currentlyRunningNode=void 0,this.shuffle=a.shuffle||!1,this.runsParent=a.runsParent||!1,this},Kiwi.extend(Kiwi.Plugins.AiTree.InnerNode,Kiwi.Plugins.AiTree.OuterNode),Kiwi.Plugins.AiTree.InnerNode.prototype.DEFAULT_NODE_NAME="Untitled inner node",Kiwi.Plugins.AiTree.InnerNode.prototype.addChild=function(a){return null==a||-1!==this.children.indexOf(a)?!1:this.hasAncestor(a)||this===a?!1:(this.children.push(a),a.addParent(this),this.updateCensus(),!0)},Kiwi.Plugins.AiTree.InnerNode.prototype.getDescendants=function(){var a,b=[];for(a=0;a<this.children.length;a++)b.push(this.children[a]),this.children[a].getDescendants&&(b=b.concat(this.children[a].getDescendants()));return b},Kiwi.Plugins.AiTree.InnerNode.prototype.hasAncestor=function(a){var b,c;if(this===a)return!0;for(b=0;b<this.parents.length;b++)if(c=this.parents[b].hasAncestor(a))return!0;return!1},Kiwi.Plugins.AiTree.InnerNode.hasDescendant=function(a){var b,c=this.getDescendants();for(b=0;b<c.length;b++)if(a===c[b])return!0;return!1},Kiwi.Plugins.AiTree.InnerNode.prototype._onUpdate=function(){this.shuffle&&this.shuffleChildren()},Kiwi.Plugins.AiTree.InnerNode.prototype.removeChild=function(a){var b=this.children.indexOf(a);return-1!==b?(this.children.splice(b,1),a.removeParent(this),this.updateCensus(),!0):!1},Kiwi.Plugins.AiTree.InnerNode.prototype.shuffleChildren=function(){for(var a,b=[];0<this.children.length;)a=Math.floor(Math.random()*this.children.length),b.push(this.children[a]),this.children.splice(a,1);this.children=b},Kiwi.Plugins.AiTree.Sequencer=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.Sequencer,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.Sequencer.prototype.DEFAULT_NODE_NAME="Sequencer inner node",Kiwi.Plugins.AiTree.Sequencer.prototype._run=function(){var a,b,c,d=0;for(void 0!==this.currentlyRunningNode&&(c=this.children.indexOf(this.currentlyRunningNode),-1!==c&&(d=c)),a=d;a<this.children.length;a++){if(b=this.children[a].update(),b===this.STATUS_RUNNING)return void(this.children[a].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[a]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));if(this.currentlyRunningNode=void 0,b===this.STATUS_FAILURE)return void(this.status=this.STATUS_FAILURE)}this.currentlyRunningNode=void 0,this.status=this.STATUS_SUCCESS},Kiwi.Plugins.AiTree.Selector=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.Selector,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.Selector.prototype.DEFAULT_NODE_NAME="Selector inner node",Kiwi.Plugins.AiTree.Selector.prototype._run=function(){var a,b,c,d=0;for(void 0!==this.currentlyRunningNode&&(c=this.children.indexOf(this.currentlyRunningNode),-1!==c&&(d=c)),a=d;a<this.children.length;a++){if(b=this.children[a].update(),b===this.STATUS_RUNNING)return void(this.children[a].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[a]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));if(this.currentlyRunningNode=void 0,b===this.STATUS_SUCCESS)return void(this.status=this.STATUS_SUCCESS)}this.currentlyRunningNode=void 0,this.status=this.STATUS_FAILURE},Kiwi.Plugins.AiTree.UntilFailure=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.UntilFailure,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.UntilFailure.prototype.DEFAULT_NODE_NAME="Until Failure inner node",Kiwi.Plugins.AiTree.UntilFailure.prototype._run=function(){var a,b,c,d=0;for(void 0!==this.currentlyRunningNode&&(c=this.children.indexOf(this.currentlyRunningNode),-1!==c&&(d=c)),a=d;0<this.children.length;){if(b=this.children[a].update(),b===this.STATUS_RUNNING)return void(this.children[a].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[a]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));if(this.currentlyRunningNode=void 0,b===this.STATUS_FAILURE)return void(this.status=this.STATUS_SUCCESS);a++,this.children.length<=a&&(a=0)}},Kiwi.Plugins.AiTree.UntilSuccess=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.UntilSuccess,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.UntilSuccess.prototype.DEFAULT_NODE_NAME="Until Success inner node",Kiwi.Plugins.AiTree.UntilSuccess.prototype._run=function(){var a,b,c,d=0;for(void 0!==this.currentlyRunningNode&&(c=this.children.indexOf(this.currentlyRunningNode),-1!==c&&(d=c)),a=d;0<this.children.length;){if(b=this.children[a].update(),b===this.STATUS_RUNNING)return void(this.children[a].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[a]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));if(this.currentlyRunningNode=void 0,b===this.STATUS_SUCCESS)return void(this.status=this.STATUS_SUCCESS);a++,this.children.length<=a&&(a=0)}},Kiwi.Plugins.AiTree.TimeLoop=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this.timerDuration=a.timerDuration||5,this},Kiwi.extend(Kiwi.Plugins.AiTree.TimeLoop,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.TimeLoop.prototype.DEFAULT_NODE_NAME="Time Loop inner node",Kiwi.Plugins.AiTree.TimeLoop.prototype._run=function(){var a,b=0,c=Kiwi.Plugins.AiTree.getTime()+this.timerDuration;if(void 0!==this.currentlyRunningNode){var d=this.children.indexOf(this.currentlyRunningNode);-1!==d&&(b=d)}for(;Kiwi.Plugins.AiTree.getTime()<c;){if(a=this.children[b].update(),a===this.STATUS_RUNNING)return void(this.children[b].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[b]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));b++,b>=this.children.length&&(b=0)}this.status=this.STATUS_SUCCESS},Kiwi.Plugins.AiTree.TimeTrial=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this.timerDuration=a.timerDuration||5,this},Kiwi.extend(Kiwi.Plugins.AiTree.TimeTrial,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.TimeTrial.prototype.DEFAULT_NODE_NAME="Time Trial inner node",Kiwi.Plugins.AiTree.TimeTrial.prototype._run=function(){var a,b=0,c=Kiwi.Plugins.AiTree.getTime()+this.timerDuration;if(void 0!==this.currentlyRunningNode){var d=this.children.indexOf(this.currentlyRunningNode);-1!==d&&(b=d)}for(;Kiwi.Plugins.AiTree.getTime()<c;){if(a=this.children[b].update(),a===this.STATUS_RUNNING)return void(this.children[b].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[b]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0));if(a===this.STATUS_FAILURE)return void(this.status=this.STATUS_FAILURE);b++,b>=this.children.length&&(b=0)}this.status=this.STATUS_SUCCESS},Kiwi.Plugins.AiTree.Inverter=function(a){return Kiwi.Plugins.AiTree.InnerNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.Inverter,Kiwi.Plugins.AiTree.InnerNode),Kiwi.Plugins.AiTree.Inverter.prototype.DEFAULT_NODE_NAME="Inverter inner node",Kiwi.Plugins.AiTree.Inverter.prototype._run=function(){var a;return 0===this.children.length?void(this.status=this.STATUS_FAILURE):(a=this.children[0].update(),a===this.STATUS_RUNNING?void(this.children[i].runsParent?(this.status=this.STATUS_RUNNING,this.currentlyRunningNode=this.children[i]):(this.status=this.STATUS_SUCCESS,this.currentlyRunningNode=void 0)):a===this.STATUS_FAILURE?void(this.status=this.STATUS_SUCCESS):void(this.status=this.STATUS_FAILURE))},Kiwi.Plugins.AiTree.Inverter.prototype.addChild=function(a){var b;if(b=Kiwi.Plugins.AiTree.InnerNode.prototype.addChild.call(this,a))for(;this.children.length>1;)this.removeChild(this.children[0]);return b},Kiwi.Plugins.AiTree.Success=function(a){return Kiwi.Plugins.AiTree.OuterNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.Success,Kiwi.Plugins.AiTree.OuterNode),Kiwi.Plugins.AiTree.Success.prototype.DEFAULT_NODE_NAME="Success outer node",Kiwi.Plugins.AiTree.Success.prototype._run=function(){this.status=this.STATUS_SUCCESS},Kiwi.Plugins.AiTree.Failure=function(a){return Kiwi.Plugins.AiTree.OuterNode.call(this,a),this},Kiwi.extend(Kiwi.Plugins.AiTree.Failure,Kiwi.Plugins.AiTree.OuterNode),Kiwi.Plugins.AiTree.Failure.prototype.DEFAULT_NODE_NAME="Failure outer node",Kiwi.Plugins.AiTree.Failure.prototype._run=function(){this.status=this.STATUS_FAILURE},Kiwi.Plugins.AiTree.Counter=function(a){return Kiwi.Plugins.AiTree.OuterNode.call(this,a),this.max=a.max||1,this.count=0,this.resetOnReady=a.resetOnReady||!1,this},Kiwi.extend(Kiwi.Plugins.AiTree.Counter,Kiwi.Plugins.AiTree.OuterNode),Kiwi.Plugins.AiTree.Counter.prototype.DEFAULT_NODE_NAME="Counter outer node",Kiwi.Plugins.AiTree.Counter.prototype._run=function(){return this.status===this.STATUS_READY&&this.resetOnReady&&(this.count=0),this.count++,this.count<this.max?void(this.status=this.STATUS_FAILURE):(this.count=0,void(this.status=this.STATUS_SUCCESS))};